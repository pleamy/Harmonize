
<!DOCTYPE html>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<html lang="en">
<html>
<head>
    <title> Harmonize!!! </title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link type="text/css" href="styles.css" rel="stylesheet" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="lib/underscore-min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <link href="dist/sp-bootstrap.min.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html"><span>Harmonize</span></a>
        </div>
        <div class="collapse navbar-collapse">
            <ul id="options" class="nav navbar-nav navbar-right">
                <li><a class="option" 
                href="http://musicmachinery.com/2014/06/26/fetching-my-starred-items-from-spotify/" 
                id='show-about'>About</a></li>
            </ul>
        </div>
    </div>
</div>



<div id="search" class="hero-unit">
    <div class="container">
        <div id="intro">
            <h1> Harmonizing...</h1>
            <p class="lead">This app demonstrates how to get the starred items for a user</p>
            <div id="search-form" class="form-inline">
                <span class="xform-control">
                    <button class="btn btn-info btn-large" id='go' type="button">  Show My Starred
                    Items</button>
                </span>
            </div>
            <div id="info"> </div>
        </div>
    </div>
</div>

<div id="main" class="container">
    <h1> Visualizating Your Music... </h1> <!-- Starred Items for <span id="who"> </span> -->
    <hr>
    <div id="item-list"> </div>
</div>

<div id="footer">
    <hr>
    <div class="container">
        <small>
            <p class="muted credit">Created by <a href="http://twitter.com/plamere">@plamere</a>. 
            Powered by <a href="http://spotify.com">Spotify</a>. Source on <a
            href="https://github.com/plamere/MyStarredItems">github</a>.
            </p>
        </small>
    </div>
</div>


<script>

var svgContainer;
var svg;
var colors;

var nodes;
var d3_data;
var force;

$(document).ready(

    function() {
        var args = parseArgs();

        if ('access_token' in args) {
            accessToken = args['access_token'];
            $("#go").hide();
            info('Getting your user profile');
            fetchCurrentUserProfile(function(user) {
                if (user) {
                    $("#who").text(user.id);
                    info('Getting your starred playlist');
                    fetchStarredItems(user.id, function(data) {
                        if (data) {
							// console.log(data);
							
							
							svg = d3.select("#main").append("svg:svg").attr("width",700).attr("height",700);
						    colors = d3.scale.category20();

							force = d3.layout.force()
						            .gravity(0.1)
						            .charge(-30)
						            .size([700, 700]);
							
							nodes = force.nodes(), centers = [];
						



						    

							// WORKS: USES MAP

							// svgContainer = d3.select("#main").append("svg").attr("width",800).attr("height",800)
							
							
							
                            showTracks(data.tracks);
							






							


                        } else {
                            error("Trouble getting the starred playlist");
                        }
                    });
                } else {
                    error("Trouble getting the user profile");
                }
            });
        } else {
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        }
    }
);




"use strict";



var accessToken = null;
var playlistFields = {
    fields:'tracks.offset,tracks.next,tracks.items(track(id,name,artists))'
};

var trackFields = {
    fields:'offset,next,items(track(name,artists))'
};

function error(msg) {
    info(msg);
}

function info(msg) {
    $("#info").text(msg);
}

function authorizeUser() {
    var client_id = '60516544c7cd4725a214c38012bd7fda';
    var redirect_uri = 'http://harmonize.parseapp.com';

    var url = 'https://accounts.spotify.com/authorize?client_id=' + client_id +
        '&response_type=token' +
        '&scope=playlist-read-private' +
        '&redirect_uri=' + encodeURIComponent(redirect_uri);
    document.location = url;
} 

function parseArgs() {
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function fetchCurrentUserProfile(callback) {
    var url = 'https://api.spotify.com/v1/me';
    callSpotify(url, null, callback);
}

function fetchStarredItems(id, callback) {
    var url = 'https://api.spotify.com/v1/users/' + id + '/starred';
	// console.log("The user's ID is " + id + ".")
    callSpotify(url, playlistFields, callback);
}

function callSpotify(url, data, callback) {
    $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + accessToken
        },
        success: function(r) {
            callback(r);
        },
        error: function(r) {
            callback(null);
        }
    });
}

var genreList = [];
var Map = {};
var mapSize = 0;
var d3_genre = [];


function showTracks(tracks) {
	
	console.log(tracks);
	var genre;
    var list = $("#item-list");
    var entries = d3.entries(tracks.items);
	
					
	// console.log('d3 entries', entries);

    // console.log('show tracks', tracks);
    if (tracks.offset == 0) {
        $("#main").show();
        $("#intro").hide();
        $("#item-list").empty();
        info("");
    }
    _.each(tracks.items, function(item) {
        var artistName = item.track.artists[0].name;
		var spotify_artist_id = item.track.artists[0].uri;
		var track_id = item.track.id;

		var artist;
		var div;
		var itemElement;

		var echonest = "http://developer.echonest.com/api/v4/artist/profile?api_key=V67QTPVRZDSNCC4AW&id=spotify:artist:" + spotify_artist_id + "&bucket=genre";
		  $.getJSON( echonest, {
		    format: "json"
		  })
		    .done(function(data) {
			genre = data.response.artist.genres;
			
			
			
			
			// for (var i = 0; i < genre.length; i++) {
			//                                                
			// 
			// 
			//                                             }

			
			//var genre_count = ;
			

			
			// console.log(genre);
			
			

				
				$(genre).each(function(i){

					 genreList.push(genre[i].name);

    
                        // update Map
                        if (Map[genre[i].name] == undefined) {
                            Map[genre[i].name] = 1;
                            mapSize++;
                        }
                        else {
                            Map[genre[i].name]++;
                        }
					var radius = Map[genre[i].name];

					console.log(radius);
					console.log(Map.length); 
					nodes.push( {name: genre[i].name, r: radius, x: 800 / 2 + offset(), y: 800 / 2 + offset(), color: colors(1)});
					// d3_data.push();
				});
				
				
				
				
				

				function offset() {
				        return Math.random() * 100;
				}
				
			

				//WORKS: USES MAP

                // for (var i = 0; i < genre.length; i++) {
                //                                     genreList.push(genre[i].name);
                //                 
                //                                     // update Map
                //                                     if (Map[genre[i].name] == undefined) {
                //                                         Map[genre[i].name] = 1;
                //                                         mapSize++;
                //                                     }
                //                                     else {
                //                                         Map[genre[i].name]++;
                //                                     }
                //                                 }
				






				
																//APPEND GENRES OF EACH ARTIST OF EACH TRACK TO LIST

												                // itemElement = $("<div>").text(artistName).css("font-weight", "bold");
												                //                 list.append(itemElement);   
												                //                 $(genre).each(function(index){
												                //                      list.append('<div id="div'+ index +'" />' + genre[index].name);
												                //                 })
				
			// console.log(Map.values());
			

				svg.selectAll("circle")
		                .data(nodes).enter()
		            .append("circle")
		            .attr("class", "node")
		            .attr("cx", function(d) {return d.x;})
		            .attr("cy", function(d) {return d.y;})
		            .attr("fill", function(d){return d.color;})
		            .attr("r", 1e-6)
		                .transition()
		            .attr("r", function(d) { return (d.r)})
					.attr("x", function(d) { return d.cx; })
				    .attr("y", function(d) { return d.cy; })
				               
		
		 force.on("tick", function(e) {

					svg.selectAll("circle")
		            .attr("cx", function(d) { return d.x; })
		            .attr("cy", function(d) { return d.y; });


		    });
		
		
			    force.start();


		    });
			
			
    });

	// console.log(Map);

	// console.log(Map.values());
	


	
		

			// console.log(nodes);
	

	
	
	//WORKS EXCEPT FOR TEXT (USES MAP RATHER THAN DYNAMIC FUNCTION)
	
	// for (var key in Map) {
	//          console.log(key);
	//          console.log(Map[key]);
	// 
	// 
	//          var circle = svgContainer
	// 					.append("circle")
	//                      	.attr("cx", Math.random() * (700 - 100) + 100)
	//                      	.attr("cy", Math.random() * (700 - 100) + 100)
	//                      	.attr("r", function(d) { return Map[key] * 3;})
	//                      	.attr("opacity", 0.5)
	//                      	.style("fill", "blue");	
	// 
	// 	var textLabels = svgContainer
	// 				.append("text")
	// 				.attr("cx", Math.random() * (700 - 100) + 100)
	//                  	.attr("cy", Math.random() * (700 - 100) + 100)
	// 				.text(function(d) { return key; })
	// 				.attr("font-family", "sans-serif")
	// 				.attr("font-size", "20px")
	// 				.attr("fill", "red")
	// 
	// 	}
	
    if (tracks.next) {
        callSpotify(tracks.next, trackFields, function(tracks) {
            showTracks(tracks);
        });


		
    }

	// var svg = d3.select("body").append("svg:svg"),
	//             colors = d3.scale.category20(),
	//             w = 900,
	//             h = 900;
	// 
	//     svg.attr("width", w).attr("height", h);
	// 
	// var force = d3.layout.force()
	//             .gravity(0.1)
	//             .charge(-30)
	//             .size([w, h]);
	// 
	// nodes = force.nodes(), centers = [];
	
	
 // for (var i = 0; i < genre.length; i++) {
 //                    genreList.push(genre[i].name);
 // 
 //                    // update Map
 //                    if (Map[genre[i].name] == undefined) {
 //                        Map[genre[i].name] = 1;
 //                        mapSize++;
 //                    }
 //                    else {
 //                        Map[genre[i].name]++;
 //                    }
 //                }

                // console.log(Map);
                // console.log(mapSize);
                // console.log("perfect");


}







// $.ajax({
// 
//   // The 'type' property sets the HTTP method.
//   // A value of 'PUT' or 'DELETE' will trigger a preflight request.
//   type: 'GET',
// 
//   // The URL to make the request to.
//   url: 'http://developer.echonest.com/aVRZDSNCC4AW&id=spotify:artist:1Cs0zKBU1kc0i8ypK3B9ai&bucket=genre',
// 
//   // The 'contentType' property sets the 'Content-Type' header.
//   // The JQuery default for this property is
//   // 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
//   // a preflight. If you set this value to anything other than
//   // application/x-www-form-urlencoded, multipart/form-data, or text/plain,
//   // you will trigger a preflight request.
//   contentType: 'text/plain',
// 
//   xhrFields: {
//     // The 'xhrFields' property sets additional fields on the XMLHttpRequest.
//     // This can be used to set the 'withCredentials' property.
//     // Set the value to 'true' if you'd like to pass cookies to the server.
//     // If this is enabled, your server must respond with the header
//     // 'Access-Control-Allow-Credentials: true'.
//     withCredentials: false
//   },
// 
//   headers: {
//     // Set any custom headers here.
//     // If you set any non-simple headers, your server must include these
//     // headers in the 'Access-Control-Allow-Headers' response header.
//   },
// 
//   success: function() {
//     // Here's where you handle a successful response.
// 	console.log("works")
//   },
// 
//   error: function() {
//     // Here's where you handle an error response.
//     // Note that if the error was due to a CORS issue,
//     // this function will still fire, but there won't be any additional
//     // information about the error.
// 		console.log("Something went wrong...")
//   }
// });
</script>
</body>
</html>
